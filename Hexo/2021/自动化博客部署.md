---
title: 自动化博客部署
toc: true
indent: true
tag:
  - Hexo
  - Gitea
  - Github Action
categories: 教程
date: '2021-07-25 03:09'
updated: '2021-07-28 2:55'
abbrlink: 42987b6b
background: /img/article/自动化博客部署/wallhaven-48o37j.png
references:
  - title: 'PGP 工作原理简述 - Nathan R. Lee'
    url: 'https://marcuseddie.github.io/2019/PGP-Introduction.html'
  - title: '如何保证发出去的微信和QQ消息不被篡改？详解 RSA 加密算法'
    url: 'https://www.bilibili.com/video/BV1Eo4y1y7Dh'    
  - title: '震惊！竟然有人在 GitHub 上冒充我的身份！'
    url: 'https://blog.spencerwoo.com/2020/08/wait-this-is-not-my-commit'
  - title: '使用 GithubActions 自动部署应用到自己的服务器（ECS）'
    url: 'https://www.kai666666.com/2020/01/04/%E4%BD%BF%E7%94%A8GithubActions%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2%E5%BA%94%E7%94%A8%E5%88%B0%E8%87%AA%E5%B7%B1%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88ECS%EF%BC%89/'
  - title: '2021 年，用更现代的方法使用 PGP（下）'
    url: 'https://ulyc.github.io/2021/01/26/2021%E5%B9%B4-%E7%94%A8%E6%9B%B4%E7%8E%B0%E4%BB%A3%E7%9A%84%E6%96%B9%E6%B3%95%E4%BD%BF%E7%94%A8PGP-%E4%B8%8B/'  
  - title: 'Github Doc - 使用 SSH 连接到 Github'
    url: 'https://docs.github.com/cn/github/authenticating-to-github/connecting-to-github-with-ssh'
  - title: 'Github Doc - 生成新 GPG 密钥'
    url: 'https://docs.github.com/cn/github/authenticating-to-github/managing-commit-signature-verification/generating-a-new-gpg-key'
  - title: 'Github Doc - 将您的签名密钥告知 Git'
    url: 'https://docs.github.com/cn/github/authenticating-to-github/managing-commit-signature-verification/telling-git-about-your-signing-key'
  - title: 'Github Doc - 新增 GPG 密钥到 GitHub 帐户'
    url: 'https://docs.github.com/cn/github/authenticating-to-github/managing-commit-signature-verification/adding-a-new-gpg-key-to-your-github-account'        
---

<div class="img-wrap">
  <div class="img-bg" style="background:var(--color-card)">
    <img class="img" src="../../img/article/自动化博客部署/Hexo博客自动化部署.svg" alt="博客部署流程" style="max-height: 800px;">
  </div>
  <span class="image-caption">博客部署流程</span>
</div>

<!-- more -->

说是自动化博客部署，其实是记录了下 **枋柚梓的猫会发光** 的部署过程，基本概括来说就是通过 Github Action 处理代码的提交，部署博客到 Github、Gitea、OSS 中，此外还包含一些 GPG 的签名提交、自托管主机遇到的一些坑和一些其它功能的使用过程。

如你所见，这个部署流程是繁杂的，如果只是将 Hexo 博客步数到 Github、OSS、CVM 等，其实都有对应现成的轮子可以用。不过出于个人定制的缘故，我将部署流程拆分成了三部分：整站内容部署到服务器（和自托管仓库）、Github 仓库；静态文件（js,css,fonts）单独同步到另一个 Github 仓库，并且接用 jsd 访问加速；图片类文件同步到腾讯云对象存储，以方便使用它的图片处理功能（自适应 Wbep、压缩等）。

同时，强迫症心理，各个环节都用上了 GPG 签名；再同时还是强迫症的缘故，网站的域名解析几乎不对境外开放（*只有 inkss 的域名做了全球解析*），所以又用上了 Github Actions 的自托管主机；再然后还自建了 Gitea 的代管托管站，又将整站同步一份到 Gitea 里。

如你所见，我也只是做了这些而已嘛，下面记录上述过程中的踩坑史。

<br>

{% noteblock quote, 本文包括但不限于以下内容： %}

- SSH 私钥提交
- GPG 部署与代码签名
- Github Action 基本语法规则
- Github Action 自托管主机使用
- Gitea 的 Webhook 及本地代码同步
- 利用 Gulp 批量替换静态资源访问地址
- 腾讯云 OSS 部署及 CDN 缓存刷新

{% endnoteblock %}

{% note bug red, 本篇文章尚未更新完毕，仍在完善中，敬请期待... %}

## 一、SSH & GPG

### 使用 SSH 连接到 Github

这部分是基础的基础，不作详细解释，大致的流程就是：生成密钥，然后将公钥上传到 Github，完了齐活儿~ 可以参考此链接操作：[使用 SSH 连接到 Github](https://docs.github.com/cn/github/authenticating-to-github/connecting-to-github-with-ssh) 。

### 使用 GPG 对提交进行签名

简要介绍一下 GPG ：{% psw 你以为我会大段的复制粘贴？并不那是无意义的。 %} B 站有一个视频对 RSA 加密讲述的很好，排除中间大段的算法部分它很形象的概括了现有的加密算法：[【软件科普】详解RSA加密算法](https://www.bilibili.com/video/BV1Eo4y1y7Dh) 。此外对于 GPG 对 Git 提交进行签名的原理可以在此链接处查看：[PGP 工作原理简述](https://marcuseddie.github.io/2019/PGP-Introduction.html) 。

至于为什么要使用 GPG 可以这样理解，由于 Git 的身份认证只需要配置用户名和邮箱，且这俩可以任意修改，甚至 Git 的 commit 都可以批量修改，那么有人伪造提交记录，Github 也是无法分别的。所以需要一个我证明是我自己的过程，也就是利用 GPG 对一次提交记录进行签名，Github 利用你上传的公钥对签名解密，验证通过后就可以相信对应的提交记录是你真实发出的。

总结就是 SSH 用来验证身份，GPG 用来验证 “著作权” 。

#### GPG 的安装

对于 Linux 用户，系统已经默认安装了 GPG ，直接使用即可；Windows 用户可以下载 GPG 的 [命令行工具](https://www.gnupg.org/download/) ，当然最简单的还是利用 [Scoop](/page/notes/shell/#Scoop-安装、部署、下载) 安装：

{% folding red, Windows 安装 scoop %}

```shell Windows 安装 scoop，其实注入 sudo、which 等基础命令也能安装
scoop install gpg
```

{% endfolding %}

#### GPG 的使用

安装完成之后就是生成 GPG 密钥对，生成过程参考此链接操作：[生成新 GPG 密钥](https://docs.github.com/cn/github/authenticating-to-github/managing-commit-signature-verification/generating-a-new-gpg-key) 。

#### GPG 的导入导出

如果已有 GPG 密钥是可以直接导入，这点比 SSH 密钥的导入导出方便很多，下面是查看系统中已有的密钥和对其导入导出的命令：

{% folding yellow, 列出您拥有其公钥和私钥 %}

```bash 列出您拥有其公钥和私钥，因为可以导入公钥验证身份，公钥可能会有多个
➜  ~ gpg --list-secret-keys --keyid-format=long 
/root/.gnupg/pubring.kbx
------------------------
sec   rsa4096/705CF548160B570E 2021-07-25 [SC]
      3B21B65778AD1331E052020D705CF548160B570E
uid                 [ultimate] inkss (inkss) <me@szyink.com>
ssb   rsa4096/0C85BC5AF8B7CF09 2021-07-25 [E]
➜  ~ gpg --list-keys --keyid-format=long 
/root/.gnupg/pubring.kbx
------------------------
pub   rsa4096/705CF548160B570E 2021-07-25 [SC]
      3B21B65778AD1331E052020D705CF548160B570E
uid                 [ultimate] inkss (inkss) <me@szyink.com>
sub   rsa4096/0C85BC5AF8B7CF09 2021-07-25 [E]
```

{% endfolding %}

其中，ses 和 pub 后跟的字符串为对应 ID，例如本例中 GPG 密钥 ID 为 `705CF548160B570E`。

{% folding green, 导出私钥和公钥 %}

```bash 导出私钥时需要验证私钥密码
➜  ~ gpg -a -o gpg-public.key --export 705CF548160B570E
➜  ~ gpg -a -o gpg-private.key --export-secret-keys 705CF548160B570E
```

{% endfolding %}

相应的导入密钥命令如下，同样导入私钥时需要输入密码。

{% folding cyan, 导入公钥和私钥 %}

```bash 导入私钥/公钥到系统中
➜  ~ gpg --import gpg-public.key 
gpg: key 705CF548160B570E: public key "inkss (inkss) <me@szyink.com>" imported
gpg: Total number processed: 1
gpg:               imported: 1
➜  ~ gpg --import gpg-private.key 
gpg: key 705CF548160B570E: "inkss (inkss) <me@szyink.com>" not changed
gpg: key 705CF548160B570E: secret key imported
gpg: Total number processed: 1
gpg:              unchanged: 1
gpg:       secret keys read: 1
gpg:   secret keys imported: 1
```

{% endfolding %}

#### GPG 的 Git 调用

当密钥导入到系统后，需要配置 Git 命令调用 GPG 签名：

{% folding blue, 配置密钥并开启全局签名验证 %}

```bash 配置 GPG 密钥 ID 并开启全局 GPG 签名验证
➜  ~ git config --global user.signingkey 705CF548160B570E
➜  ~ git config --global commit.gpgsign true
```

{% endfolding %}

## 二、Github Action

## 三、附录内容

### GPG 的免密校验

在使用 GPG 对 Git 提交签名的过程中，每次都需要输入主密码对私钥进行认证，这类交互式程序个人使用还好，但是在 Action 这种无人值守的自动程序中就面临凉凉的问题了，我检索了一部分资料实在没找到如果在 Git 提交的过程中自动完成密钥验证。不过倒是找到了免密解密文件，由于密码有一定的缓存时间，那么在正式的 Git 提交前我只需要进行一次密码的缓存操作，在 Action 的配合下四舍五入下也算完成了免密提交。

大致流程是这样：首先就是利用公钥加密一份文件，然后在 Git 提交前对加密后的文件执行一次解密以刷新密码的缓存时间。

```shell PASSWD 为写有密码的文件，szyink.gpg 为待解密文件
gpg -d --pinentry-mode=loopback --passphrase-file PASSWD ~/gpg/szyink.gpg
```

### 是否要将 GPG 公钥提交

在诸如阮一峰的博客中，都提到过将 GPG 公钥上传到公钥服务器中，但是我在读到 [2021年，用更现代的方法使用PGP（下）](https://ulyc.github.io/2021/01/26/2021%E5%B9%B4-%E7%94%A8%E6%9B%B4%E7%8E%B0%E4%BB%A3%E7%9A%84%E6%96%B9%E6%B3%95%E4%BD%BF%E7%94%A8PGP-%E4%B8%8B/#%E5%AE%89%E5%85%A8%E9%A3%8E%E9%99%A9%E5%92%8C%E4%BA%89%E8%AE%AE-%E8%A2%AB%E7%8E%A9%E5%9D%8F%E7%9A%84keyserver) 中的 *安全风险和争议， 被玩坏的 KeyServer* 后，忽然就意识到我完全没有将公钥公布出去的需求，它提供的加密功能又不会在生活中用到，最多最多只是用在 Github 之类的验证上，但是上传到公钥服务器就意味着永远无法删除，这不太好。

### Github Action 的运行目录

对于 Github 的主机来说，项目的运行目录位于（起码 ubuntu 主机是这样），而自托管主机就需要看个人配置了，直接登陆到服务器查看它不更香嘛。

```bash project-name: 仓库名称
~/work/project-name/project-name/
```

