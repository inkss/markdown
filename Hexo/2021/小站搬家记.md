---
title: 小站搬家记
toc: true
indent: true
tag:
  - 网站
  - Linux
categories: 博客
date: '2021-06-18 01:25'
updated: '2021-06-18 01:25'
abbrlink: 56dd46d6
description: 横竖俩字：搬家~
---

从阿里云迁到腾讯云了，从服务器迁到轻量服务器了，从辽备迁到皖备了。心路历程可以参见这篇文章：[小站的搬家经历](https://szyink.com/archives/702/)。此处记录搬家历史。对于动态网站，搬家无非就是两件事，搬网站目录的所有文件和搬数据库，一般来说迁移完这俩基本就好使了。但是我的新旧服务器基础环境不一致：

*服务器从 CentOS 7.8 换成了 8.4，PHP 从 7.2 换成了 8.0， Nginx 升级到了 1.20， 数据库升级到了 10.5.6 的样子。*

Typecho 正式版真的好久没更新了，都怀疑不支持这个 PHP 版本，于是就选择了新装开发版，除了 `/usr` 目录进行了替换之外，其余内容均没有修改。数据库这边宝塔导出来的备份文件其实是含建库过程的 SQL 脚本。所以迁移网站似乎确实没啥，即使环境不一致。

哈，碎碎念结束，网站确实没啥，主要是应用环境没了，这点有点烦人，重新配置真消磨时间。

## 一、服务器初始配置

### 系统初始配置

在腾讯云控制台重置 root 密码，以及配置密钥和开放防火墙（后期使用宝塔自带的防火墙）。

```sh 系统初始化
# 系统升级
yum update

# 安装常用软件
yum install git zsh wget vim

# 安装 oh-my-zsh
sh -c "$(wget -O- https://cdn.jsdelivr.net/gh/robbyrussell/oh-my-zsh/tools/install.sh)"
```

### 安装宝塔面板

关于面板 SSL，此处我这里出了问题，申请证书时一直报错，只能先使用自签证书，然后将主域名的证书文件软链接到宝塔面板证书处。如果能在开启 SSL 处申请成功那自然最好。

```sh 雷峰塔中有白蛇
# 安装面板
yum install -y wget && wget -O install.sh http://download.bt.cn/install/install_6.0.sh && sh install.sh

# 淦掉账户登录校验
rm -f /www/server/panel/data/bind.pl

# 主域名博客用，分配二级域名绑定宝塔。
# 主域名申请泛域名证书，宝塔面板开启 SSL，修改证书路径的主域名证书处。
ln /www/server/panel/vhost/cert/szyink.com/privkey.pem /www/server/panel/ssl/privateKey.pem
ln /www/server/panel/vhost/cert/szyink.com/fullchain.pem /www/server/panel/ssl/certificate.pem
```

### 安装 Docker

```sh 文档地址：https://docs.docker.com/engine/install/centos/
# 移除可能的旧版本
yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine

# 安装 yum-utils 包并设置稳定版存储库
yum install -y yum-utils
yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo

# 安装最新版本的 Docker 引擎
yum install docker-ce docker-ce-cli containerd.io

# 启动 Docker
systemctl start docker
```

### 用户管理

新建一个 coder 用户以方便搭建 code－server（root 账户下执行）

```sh coder 用户
# 新建用户
useradd -m coder

# 为新用户设置密码
passwd coder

# 将新用户添加到 docker 组
gpasswd -a coder docker
```

配置 coder 用户

```sh 在 coder 用户中执行
# 参考上文更换 shell 为 oh-my-zsh

# 安装 nvm，参考提示配置环境变量并刷新
wget -qO- https://cdn.jsdelivr.net/gh/creationix/nvm/install.sh | sh
source .zshrc

# 安装 node & hexo
nvm install --lts
npm install hexo-cli -g

# 配置 ssh
```

未完待续 or 鸽了
