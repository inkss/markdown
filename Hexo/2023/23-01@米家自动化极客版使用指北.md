---
title: 米家自动化极客版使用指北
showPostHeadimg: false
toc: true
indent: true
tag:
  - 米家
  - 智能家居
categories: 教程
description: >-
  可以预见的，在米家智能化这块儿，Zigbee 路线已被事实上放弃，米家新的产品路线转为蓝牙 Mesh。在这个背景下米家推出了小米智能中枢网关，官宣可同时连接
  200 个蓝牙 Mesh 设备和 100 个蓝牙设备，同时部分自动化可本地运行，无需再走米家云端。
date: '2023-02-02 01:00'
updated: '2024-10-28 00:10'
copyright:
  type: type5
headimg: ../../img/article/23-01@米家自动化极客版使用指北/Hexo博客封面.png
abbrlink: 78a787b3
---

{% folding cyan, 文章更新日志 %}

{% timeline %}

{% timenode 2023-02-09 %}

  + 初始化文章
  + 更换主图、配图

{% endtimenode %}

{% timenode 2023-11-10 %}

  + 补充极客版虚拟事件
  + 更新案例内容
  + 替换配图

{% endtimenode %}

{% timenode 2024-03-03 %}

  + 补充米家与小米手机联动部分的内容

{% endtimenode %}

{% timenode 2024-10-25 %}

  + 补充一些小技巧
  + 重写案例部分的内容

{% endtimenode %}

{% endtimeline %}

{% endfolding %}

## 一、简介

可以预见的，在米家智能化这块儿，Zigbee 路线已被事实上放弃，米家新的产品路线转为蓝牙 Mesh。在这个背景下米家推出了小米智能中枢网关，官宣可同时连接 200 个蓝牙 Mesh 设备和 100 个蓝牙设备，同时部分自动化可本地运行，无需再走米家云端。本文提到的米家自动化极客版便是基于该中枢网关，目前拼多多上 260+ 可入手。

与米家客户端相比，极客版展示了智能家居的所有预设属性、方法和事件，同时支持查询、判断、逻辑运算等流程的处理能力，能实现很多原米家无法实现的功能。举一个简单的例子：不同时间段下的最大亮灯时间限制，即开灯后如果是白天，便一小时后关灯，反之两个小时关灯，在米家中，自动化事件只能以事件发生 + 状态条件 = 设备执行来操作，单个自动化中缺少 else 流程，同时状态条件也无法指定时间段，单一流程根本无法实现这种需求，但是在极客版中使用条件卡片就很容易实现。

极客版以卡片为主，主要分为事件和状态节点两类，通过在不同卡片间的节点连线完整自动化流程的设计，故虽然名为极客版，但总体上手难度还是很容易的。

## 二、卡片

### 2.1 卡片类型

极客版卡片的使用对我最大的感悟是，千万不能代入编程的思想。就好比它的条件卡片就是一个条件，它即使是判断那也是事件型的，只有信号的触发响应一说，下面挑出机个我认为需要留意的卡片展开讲讲。

#### 循环卡片

循环卡片可按照设置时间循环发出信号，同时支持停止循环操作。一种使用场景是将不能作为触发的智能设备通过循环查询间接实现触发功能。比如米家的饮水机，我希望它能在水箱没水时提醒我一下，但是饮水机无法作为触发，那么就用循环查询来实现：

![水箱缺水提醒](../../img/article/23-01@米家自动化极客版使用指北/循环.png)

由于目前极客版没有一个类似任务管理器的功能，循环卡片的使用还是要慎重，原则上尽量不用秒级循环，此外还可以在满足一定条件下减缓循环的进行，一个模拟示例：当循环连续触发三次后，停止循环运行，并在 30s 后开启循环。

![延迟循环触发](../../img/article/23-01@米家自动化极客版使用指北/延迟循环触发.png)

#### 延时卡片

使用延时卡片的时候曾想到一个问题：如果某个自动化很长，一次执行的所消耗的时间也很久，那么当该自动化二次触发时，上一次流程没有完全走完的情况下，第二次触发会放弃上一次流程中的未完节点直接重新开始吗？

![延时测试](../../img/article/23-01@米家自动化极客版使用指北/延时测试.png)

正确答案是：延时会立即重置，同时由于延时没有停止一说，只能重置或走完，所以上图第一个延时被重置但还没走到第二个延时时，第二个延时会继续保留上一次的执行状态，存在听到两次滴滴的情况。

#### 循环及延时卡片的状态维持

循环卡片首次触发时会立即产生一次输出事件：音响发出”滴滴“声；==循环卡片不会被重置循环状态==，既首次触发后二次触发不重置循环时间：开启台灯后音响不会同时发出”滴滴“和”哒哒“声音；==延迟卡片会被重置状态==，每次被触发，延时均会从新开始：音响永远也不会发出”呱呱“声。

![状态维持](../../img/article/23-01@米家自动化极客版使用指北/状态维持-1730043767674-1.png)

#### 自定义状态卡片

自定义状态卡片可以视为一个布尔类型的变量，相比于事件更常用于状态，可以记录储存一个值。作为状态使用时，==如果没有初始化的话默认为假==，如下图，音响会播放：哒哒。

![测试：自定义状态](../../img/article/23-01@米家自动化极客版使用指北/测试：自定义状态.png)

#### 状态维持卡片

状态维持了一段时间：输入状态和限定时间，输出状态或事件。核心点在状态的保持，作为事件时它有点类似于延时+判断卡片的结合体，也可以用于减少误判，延缓事件立即执行。

![状态维持](../../img/article/23-01@米家自动化极客版使用指北/状态维持.png)

#### 变量卡片

变量有文本和数值两类，数值类在进行运算时需要留意精度问题（用函数把值四舍五入掉）。

![数值精度](../../img/article/23-01@米家自动化极客版使用指北/数值精度.png)

### 2.2 小技巧

#### 优先记录状态而非现查

中枢网关面对的是不同物理设备，它们之间的通信需要考虑现实中的时间。提前把状态值记录进中枢网关，比在触发前再查询速度上会更高。

![状态替代查询](../../img/article/23-01@米家自动化极客版使用指北/状态替代查询.png)

#### 对循环卡片的改进

上面的循环卡片的自动化实现了白天时最多三次的水箱缺水提醒，当然这样的循环设计很不优雅，如果再加入一个存在传感器会好很多：

![用真实的人存在作为触发更实用](../../img/article/23-01@米家自动化极客版使用指北/用真实的人存在作为触发更实用.png)

#### 操控未被支持的设备

~~由于极客版和米家是独立的，如果想操控不被支持的设备，那么可以尝试使用米家音响类设备，使用【智能音响-执行文本指令】静默执行相关命令。典型场景为：第三方配件、小爱音箱创建的红外控制卡片，总之是能被小爱执行的命令都可以使用执行文本指令触发。~~

{% blocknote quote, 【更新】 %}

目前极客版已支持蓝牙网关发出/接收虚拟事件，并可在米家自动化中接收和触发。

{% endblocknote %}

#### 外网访问米家极客版

这个比较简单，虽然聊胜于无：

- 映射任意端口到中枢网关地址的 80 端口；
- 映射 8082 端口到中枢网关地址的 8082 端口。

{% note info, TIP：8082 端口使用 ws 协议作为心跳，故而无法使用 https 协议，外网不太安全。 %}

## 三、案例

### 离家与到家

检测人的到家、离家，可以通过检测个人携带的设备，例如手机进行判断，大概有这几种方案：

- 智能门锁：通过生物信息监测离家到家，缺点是没那么精准；
- 地理围栏传感器：通过蓝牙、Wifi 检测设备的在线状态，缺点是需要买设备，但兼容性强；
- 小米手机及米家事件联通：连接/断开指定名称的 Wifi 时发出事件，缺点是手机需要是小米手机^[此外还需要在这些手机的米家中登录相同的账户，这是另一个小缺点。]。

以第三个为例，现在米家 APP 中设置好对应连接/断开 Wifi 事件的触发，通过虚拟事件传递给中枢网关，在中枢中处理判断完成后再传回米家，进行开关设备上的处理。

![米家@移动设备联动](../../img/article/23-01@米家自动化极客版使用指北/米家@移动设备联动.png)

### 客厅自动化开关灯

- 有人 + 昏暗开灯（人出现）、昏暗 + 有人开灯（人一直存在，环境逐渐变暗）的双触发；

- 存在一个物理开关用于整体控制自动开关灯的条件，并可自动恢复，这里使用了指示灯；
- 只有自动开的灯才进行自动关灯，手动开灯只做无人最长时间关灯的补充限制；
- 在主动关灯不久后的立即开灯行为，由小爱主动发出询问：是否临时关闭自动化开关灯；
- 对上一条临时关闭自动化开关灯行为的主动解除：2s 内手动开关灯一次。

![客厅@自动化开关灯](../../img/article/23-01@米家自动化极客版使用指北/客厅@自动化开关灯.png)

### 自动化开关灯的延时惩罚

存在一种场景：灯设置为无人1分钟自动关灯，同时人频繁出入这个房间，但间隔时间可能大于1分钟，这样导致灯频繁的处在开启关闭、开启关闭的响应中。所以需要适当的延时/缩短自动化关灯的时间，也就是实现动态关灯时间控制。

主要思路如下：由于在循环和延时卡片中无法使用变量，所以我们需要先计算出数据，再一个个单独判断去执行。所以如下，先记录由自动化行为导致的开关灯时间，接着比较这个差值，按照实际需求将差值转换成延时（惩罚）系数，最后再对这个系数判断，进而决定具体的延时关灯时间。

![次卧@自动化开关灯](../../img/article/23-01@米家自动化极客版使用指北/次卧@自动化开关灯.png)
