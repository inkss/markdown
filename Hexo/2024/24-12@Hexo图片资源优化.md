---
title: é™æ€ç½‘ç«™å›¾ç‰‡ä¼˜åŒ–
toc: true
indent: true
tag:
  - å›¾ç‰‡ä¼˜åŒ–
  - ç½‘ç«™ä¼˜åŒ–
categories: æ–‡æ¡£
description: 'è¿™ç¯‡æ–‡ç« è¯¦ç»†ä»‹ç»äº†å¦‚ä½•ä¼˜åŒ–åšå®¢çš„å›¾ç‰‡èµ„æºï¼ŒåŒ…æ‹¬å›¾ç‰‡å‹ç¼©ã€æ ¼å¼è½¬æ¢ï¼ˆå¦‚ WebP å’Œ AVIFï¼‰ã€æµè§ˆå™¨å…¼å®¹æ€§å¤„ç†ã€CDN ç¼“å­˜é—®é¢˜è§£å†³ä»¥åŠå›¾ç‰‡æ‡’åŠ è½½å’Œä¸»é¢˜å…¼å®¹æ€§å¤„ç†ã€‚é€šè¿‡ä½¿ç”¨ lovell/sharp åº“å’Œ ffmpeg å·¥å…·ï¼Œæ–‡ç« æä¾›äº†å…·ä½“çš„ä»£ç ç¤ºä¾‹å’Œå®ç°æ–¹æ³•ï¼Œå¸®åŠ©è¯»è€…æé«˜åšå®¢çš„åŠ è½½é€Ÿåº¦å’Œç”¨æˆ·ä½“éªŒã€‚'
date: '2024-12-27 15:30'
updated: '2025-03-10 23:33'
copyright:
  type: cc
headimg: ../../img/article/24-12@Hexoå›¾ç‰‡èµ„æºä¼˜åŒ–/Hexoåšå®¢å°é¢.png
abbrlink: 9659af8e
---

é™æ€åšå®¢å°±æ˜¯å¥½ï¼Œæ‰€æœ‰èµ„æºéƒ½èƒ½æå‰é¢„å¤„ç†ï¼šå›¾ç‰‡å‹ç¼©ã€è½¬ webp, avif ã€æ‡’åŠ è½½ç­‰ç­‰ã€‚

<!-- more -->

è¿™æ˜¯ä¸€ä¸ªè€ç”Ÿå¸¸è°ˆçš„è¯é¢˜ï¼Œå…³äºä¼˜åŒ–åšå®¢å›¾ç‰‡èµ„æºï¼ŒåŒ…æ‹¬ä½†ä¸é™äºå›¾ç‰‡å‹ç¼©ã€ä½¿ç”¨æ›´ä¼˜çš„æ–‡ä»¶æ ¼å¼ä»¥åŠæµè§ˆå™¨å…¼å®¹æ€§å¤„ç†ã€‚ä»Šå¤©æˆ‘æ‰“ç®—é‡æ–°æ•´ç†å’Œå½’çº³ä¸€ä¸‹ã€‚ä»¥å‰ï¼Œæœ¬ç«™é‡‡ç”¨äº†åŸºäº gulp çš„å›¾ç‰‡å‹ç¼©å’Œ webp æ ¼å¼è½¬æ¢ï¼Œä½†æ•ˆæœä¸ä½³ï¼Œæœ€ç»ˆè½¬è€Œä½¿ç”¨äº†è…¾è®¯äº‘ CDN çš„æ•°æ®ä¸‡è±¡æœåŠ¡ã€‚

å¦‚ä»Šï¼Œéšç€æ¶ˆè´¹é™çº§ï¼Œæˆ‘ä»¬è¿˜æ˜¯å‡å°‘å¯¹ä»˜è´¹æœåŠ¡çš„ä¾èµ–å§ã€‚åœ¨æµè§ˆåšå®¢æ—¶ï¼Œæˆ‘çœ‹åˆ° Heo çš„ä¸€ç¯‡ [å®ç°å…¨ç«™å›¾ç‰‡ä½¿ç”¨ avif æ ¼å¼ï¼Œæ›¿ä»£è‡ƒè‚¿çš„ webp æ•™ç¨‹](https://blog.zhheo.com/p/6a933575.html) ã€‚æ–°çš„å›¾ç‰‡æ ¼å¼çœŸæ˜¯å¦‚é›¨åæ˜¥ç¬‹èˆ¬å±‚å‡ºä¸ç©·ã€‚Whateverï¼Œé‚£ä¹ˆé‡æ–°åŠ å…¥æœ¬åœ°å¤„ç†èƒ½åŠ›ï¼Œé™¤äº† webpï¼Œç°åœ¨è¿˜è¦æ”¯æŒ avif æ ¼å¼ã€‚

## ä¸€ã€å›¾ç‰‡å‹ç¼©è½¬æ¢

æˆ‘ä»¬æœ‰ä¸¤ä¸ªç›®æ ‡ï¼šé¦–å…ˆæ˜¯å‹ç¼©åŸå§‹å›¾ç‰‡ï¼Œå…¶æ¬¡æ˜¯å°†å…¶è½¬æ¢ä¸º webp å’Œ avif æ ¼å¼ã€‚è€ƒè™‘åˆ° Hexo åŸºäº Node.js å¼•æ“ï¼Œæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ [lovell/sharp](https://github.com/lovell/sharp) è¿™ä¸ªå‰ç«¯åº“ã€‚è¿™ä¸ªåº“ä¸ä»…èƒ½å‹ç¼©å›¾ç‰‡ï¼Œè¿˜èƒ½è½¬æ¢å›¾ç‰‡æ ¼å¼ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ Node.js ç¯å¢ƒä¸­è¿è¡Œã€‚ä¸äºŒä¹‹é€‰ï¼Œå®Œç¾è‡³æã€‚

### 1.1 å¤„ç†æ€è·¯

- é¦–å…ˆå‹ç¼©åŸå§‹å›¾ç‰‡ï¼Œç”Ÿæˆä½“ç§¯å°äºåŸå§‹æ–‡ä»¶çš„å‹ç¼©ç‰ˆæœ¬ã€‚
- ä»…è½¬æ¢ç‰¹å®šæ ¼å¼çš„å›¾ç‰‡ï¼Œé€šå¸¸åªå¤„ç† `jpg`ã€`jpeg` å’Œ `png` ç­‰æ ¼å¼ã€‚
- æ€§èƒ½ä¼˜åŒ–ï¼šå¦‚æœå¾…å¤„ç†çš„ç›®å½•ä¸­å·²ç»å­˜åœ¨åŒåçš„ webp æˆ– avif æ–‡ä»¶ï¼Œå°±è·³è¿‡è¯¥æ–‡ä»¶ï¼Œä¸å†è¿›è¡Œå¤„ç†ã€‚

```js æ ¸å¿ƒä»£ç ç¤ºä¾‹
const processFolder = async (folder) => {
  const files = await fs.promises.readdir(folder);
  const filePromises = files.map(async (file) => {
    const inputFilePath = path.join(folder, file);
    const stats = await fs.promises.stat(inputFilePath);

    if (stats.isDirectory()) {
      await processFolder(inputFilePath); // é€’å½’å¤„ç†å­ç›®å½•
    } else if (stats.isFile() 
        && includeFormats.includes(path.extname(inputFilePath).toLowerCase())) {
      //...

      if (!fs.existsSync(webpPath) || !fs.existsSync(avifPath)) {
        await compressImage(inputFilePath);
        await convertImage(inputFilePath);
      } else {
        logger.info(`è·³è¿‡ ${file}ï¼Œå·²è½¬æ¢ä¸º WebP å’Œ AVIF`);
      }
    }
  });

  await Promise.all(filePromises); // å¹¶è¡Œå¤„ç†æ–‡ä»¶
}
```

### 1.2 è¡¥å……å†…å®¹

Sharp åº“æ”¯æŒ GIF å‹ç¼©ï¼Œä½†ä¼šä¸¢å¤±åŠ¨ç”»ä¿¡æ¯ï¼Œå¹¶ä¸”ä¸æ”¯æŒå°† GIF è½¬æ¢ä¸º webp å’Œ avif æ ¼å¼ã€‚å› æ­¤ï¼Œé¢å¤–æ·»åŠ ä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœå½“å‰ç³»ç»Ÿä¸­å®‰è£…äº† ffmpegï¼Œåˆ™åˆ©ç”¨å®ƒæ¥å®Œæˆ GIF çš„æ ¼å¼è½¬æ¢ã€‚

```sh git to webp
ffmpeg -i ${inputFilePath} -c:v libwebp -lossless 0 -q:v 80 -loop 0 -an -vsync 0 ${webpPath}
```

```sh gif to avif
ffmpeg -i ${inputFilePath} -c:v libsvtav1 -qp 40 ${avifPath}
```

### 1.3 å®Œæ•´ä»£ç 

å®Œæ•´è„šæœ¬å†…å®¹å¦‚ä¸‹ï¼Œä½¿ç”¨æ—¶éœ€å®‰è£…å¯¹åº”ä¾èµ–[^sharp]ï¼š

[^sharp]: ç»ˆç«¯ä¸‹å®‰è£…ä¾èµ– sharp

    ```sh
    npm install sharp --save
    ```

{% link sharp.js, https://gist.githubusercontent.com/inkss/6f76ec73bb34052dcd2976063b1884aa/raw/e9af74d607b396c79e9300c7cb7138bf253187bb/sharp.js %}

### 1.4 ä½¿ç”¨æŒ‡å—

å‡è®¾è„šæœ¬ä½äº `.tools/sharp.js` æ–‡ä»¶ä¸­ï¼Œå¹¶ä¸”æ‰€æœ‰å›¾ç‰‡æ–‡ä»¶éƒ½å­˜æ”¾åœ¨ `./source/image` ç›®å½•ä¸‹ï¼Œå¯æ˜¯ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å®ç°è‡ªåŠ¨å›¾ç‰‡è½¬æ¢ï¼š

```sh
node ./tools/sharps.js
```

è½¬æ¢åçš„æ–‡ä»¶ä¼šä¿å­˜åœ¨åŒä¸€è·¯å¾„ä¸‹ï¼Œè¿™å¯èƒ½ä¼šç¨å¾®å¢åŠ æ‚¨çš„ä»“åº“ä½“ç§¯ã€‚å¦‚æœæ‚¨ä»‹æ„ç©ºé—´å ç”¨ä½†ä¸ä»‹æ„åœ¨éƒ¨ç½²æ—¶èŠ±è´¹æ›´å¤šæ—¶é—´ï¼ˆæˆ–è€…åœ¨è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬ä¸­ä½¿ç”¨ï¼‰ï¼Œåˆ™å¯ä»¥é€‰æ‹©å¯¹ `./public/image` ç›®å½•è¿›è¡Œå¤„ç†ï¼š

```sh
node ./tools/sharps.js ./public/image
```

### 1.5 å‹ç¼©æ•ˆæœ

çœ‹çœ‹æ•ˆæœï¼Œè¿™æ˜¯ä¸‰å¼ å›¾ç‰‡ï¼š

{% gallery stretch, 3, two %}
![png æ ¼å¼ï¼Œ997kb](https://bu.dusays.com/2025/01/14/678603df20087.png)

![webp æ ¼å¼ï¼Œ154kb](https://bu.dusays.com/2025/01/14/678603de0664b.webp)

![avif æ ¼å¼ï¼Œ69kb](https://inkss.cn/img/default/æ¡Œé¢èƒŒæ™¯.avif)
{% endgallery %}

## äºŒã€å›¾ç‰‡èµ„æºè°ƒç”¨

åªå…³å¿ƒ Chromium ç³»çš„å…¼å®¹æ€§ï¼Œwebp 32 æ”¯æŒï¼Œavif 85 æ”¯æŒã€‚avif çš„å…¼å®¹æ€§æœ‰é‚£ä¹ˆä¸€ç‚¹ç‚¹æ¬ ä½³ã€‚ä¼ ç»ŸæŠ€èƒ½ï¼Œä½¿ç”¨ picture æ ‡ç­¾æä¾›å›é€€å›¾åƒï¼ˆChromium 38ï¼‰ã€‚

> **HTML `<picture>` å…ƒç´ ** é€šè¿‡åŒ…å«é›¶æˆ–å¤šä¸ª [source](https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/source) å…ƒç´ å’Œä¸€ä¸ª img å…ƒç´ æ¥ä¸ºä¸åŒçš„æ˜¾ç¤º/è®¾å¤‡åœºæ™¯æä¾›å›¾åƒç‰ˆæœ¬ã€‚æµè§ˆå™¨ä¼šé€‰æ‹©æœ€åŒ¹é…çš„å­ `<source>` å…ƒç´ ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…çš„ï¼Œå°±é€‰æ‹© `<img>` å…ƒç´ çš„ `src` å±æ€§ä¸­çš„ URLã€‚ç„¶åï¼Œæ‰€é€‰å›¾åƒå‘ˆç°åœ¨ `<img>` å…ƒç´ å æ®çš„ç©ºé—´ä¸­ã€‚

å› æ­¤ï¼Œå¯¹äºå¸¸è§„çš„ `<img>` æ ‡ç­¾ï¼Œå¯ä»¥æ›¿æ¢ä¸ºï¼š

```html
<picture>
  <source srcset="diagram.avif" type="image/avif" />
  <source srcset="diagram.webp" type="image/webp" />
  <img src="diagram.png" alt="æ•°æ®é€šé“ç¤ºæ„å›¾" />
</picture>
```

### 2.1 å¤„ç†æ€è·¯

- éå†æ‰€æœ‰ HTML æ–‡ä»¶ï¼Œåˆ©ç”¨ JSDOM å°†å…¶è½¬æ¢ä¸º NodeList å¯¹è±¡ï¼Œä¾¿äºåç»­å¤„ç†ã€‚
- è¿‡æ»¤å‡ºéœ€è¦å¤„ç†çš„ img æ ‡ç­¾å¹¶è¿›è¡Œæ›¿æ¢ã€‚å¦‚æœè½¬æ¢åçš„æ–‡ä»¶ä½“ç§¯æ¯”åŸæ–‡ä»¶æ›´å¤§ï¼Œåˆ™ä¸è¿›è¡Œæ›¿æ¢ã€‚

```js æ ¸å¿ƒä»£ç ç¤ºä¾‹
const fileContent = await fs.promises.readFile(filePath, 'utf-8');
const dom = new JSDOM(fileContent);

[...document.querySelectorAll('img')].forEach(img => {
    const picture = document.createElement('picture');
    
    picture.appendChild(sourceAvif);
    picture.appendChild(sourceWebp);
    picture.appendChild(img.cloneNode(true));

    img.replaceWith(picture);
})
```

```js æ ¡éªŒæ–‡ä»¶å¤§å°
const [originalStats, targetStats] = await Promise.all([
    fs.promises.stat(originalFilePath),
    fs.promises.stat(targetFilePath),
]);
return targetStats.size < originalStats.size;
```

### 2.2 å®Œæ•´ä»£ç 

å®Œæ•´è„šæœ¬å†…å®¹å¦‚ä¸‹ï¼Œä½¿ç”¨æ—¶éœ€å®‰è£…å¯¹åº”ä¾èµ–[^sharp_html]ï¼š

[^sharp_html]: ç»ˆç«¯ä¸‹å®‰è£…ä¾èµ– jsdom

    ```sh
    npm install jsdom --save
    ```

{% link sharp_html.js, https://gist.githubusercontent.com/inkss/6f76ec73bb34052dcd2976063b1884aa/raw/e9af74d607b396c79e9300c7cb7138bf253187bb/sharp_html.js %}

### 2.3 ä½¿ç”¨æŒ‡å—

```js ä»£ç ç‰‡æ®µ
// ä»å‘½ä»¤è¡Œå‚æ•°è·å–è¾“å…¥æ–‡ä»¶å¤¹
const inputFolder = path.resolve(process.cwd(), process.argv[2] || './public'); 
// åˆ¤æ–­ç”¨æ¡ä»¶
const targetDomain = 'https://static.inkss.cn/img/'; 
// å ä½å›¾
const placeholder = "https://static.inkss.cn/img/default/transparent-placeholder-1x1.svg"; 
```

ä¿®æ”¹ `targetDomain` å­—æ®µä¸ºä½ çš„å›¾ç‰‡èµ„æºå‰ç¼€ï¼Œç¨‹åºä¼šæŸ¥æ‰¾ html æ–‡ä»¶ä¸­çš„æ‰€æœ‰ img æ ‡ç­¾ï¼Œå¹¶å°†å…¶å¼•ç”¨åœ°å€ä¸è¯¥å‰ç¼€è¿›è¡ŒåŒ¹é…ã€‚åŒ¹é…æˆåŠŸåˆ™è¿›è¡Œå¤„ç†ï¼Œä½¿ç”¨ `placeholder` çš„å€¼ä½œä¸ºé»˜è®¤å ä½å›¾ã€‚

å‡è®¾è„šæœ¬ä½äº `.tools/sharp_html.js` æ–‡ä»¶ä¸­ï¼Œè°ƒç”¨æ–¹å¼ä¸ä¸Šä¸€å°èŠ‚ç±»ä¼¼ï¼Œä½†å¦‚æœä¸æŒ‡å®šè·¯å¾„ï¼Œé»˜è®¤å¤„ç† `./public` è·¯å¾„ä¸‹çš„ HTML æ–‡ä»¶ã€‚

```sh
node ./tools/sharp_html.js ./public/image
```

## ä¸‰ã€å›¾ç‰‡æ—¶é—´æˆ³

ç”±äº CDN çš„ç¼“å­˜æ—¶é—´è®¾ç½®è¾ƒé•¿ï¼Œä¾‹å¦‚æµè§ˆå™¨å›¾ç‰‡ç¼“å­˜çš„è¿‡æœŸæ—¶é—´ä¸ºä¸ƒå¤©ï¼Œè¿™å¯¼è‡´å¦‚æœå›¾ç‰‡å‘ç”Ÿå˜åŠ¨ï¼Œé™¤éå¼ºåˆ¶åˆ·æ–°ï¼Œå¦åˆ™å®¢æˆ·ç«¯åœ¨äºŒæ¬¡è®¿é—®æ—¶æ— æ³•ç«‹å³è·å–æœ€æ–°çš„å›¾ç‰‡å†…å®¹ã€‚

### 3.1 å¤„ç†æ€è·¯

- ä» git ä¸­è¯»å–æœ€è¿‘ä¸ƒå¤©çš„æäº¤è®°å½•ï¼Œè¿‡æ»¤å‡ºæ‰€æœ‰æ¶‰åŠå›¾ç‰‡æ–‡ä»¶å˜åŠ¨çš„è®°å½•ã€‚
- éå† HTML æ–‡ä»¶ä¸­çš„æ‰€æœ‰å›¾æ ‡æ ‡ç­¾ï¼Œå¹¶ä¸å˜åŠ¨è®°å½•è¿›è¡Œæ¯”è¾ƒã€‚å¦‚æœåŒ¹é…ï¼Œåˆ™åœ¨å›¾ç‰‡åœ°å€åè¿½åŠ æ—¶é—´æˆ³ã€‚

```js
const getRecentCommits = async () => {
  try {
    const { stdout } = await execPromise('git log --since="7 days ago" --name-only --pretty=format: -z');
    return stdout.split('\0').map(file => file.trim()).filter(file => file);
  } catch (err) {
    logger.error(`è·å–æœ€è¿‘æäº¤æ—¶å‡ºé”™: ${err.message}`);
    return [];
  }
}
```

### 3.2 å®Œæ•´ä»£ç 

{% link timestamp.js, https://gist.githubusercontent.com/inkss/6f76ec73bb34052dcd2976063b1884aa/raw/e9af74d607b396c79e9300c7cb7138bf253187bb/timestamp.js %}

### 3.3 è°ƒç”¨æ–¹å¼

```sh
node ./tools/timestamp.js ./public
```

## å››ã€å›¾ç‰‡æ‡’åŠ è½½

### 4.1 æ‡’åŠ è½½å®ç°

åœ¨å‡å°‘æ–‡ä»¶å¤§å°ä¹‹åï¼Œæ¥ä¸‹æ¥å°è¯•ä¸ºå›¾ç‰‡æ·»åŠ æ‡’åŠ è½½å¤„ç†ï¼šåœ¨ â€œå›¾ç‰‡èµ„æºè°ƒç”¨â€ éƒ¨åˆ†ï¼ŒåŒæ­¥å°†å›¾ç‰‡çš„ `src` å±æ€§ä¿®æ”¹ä¸º `data-src`ï¼Œå¹¶å°†å†…å®¹æ›¿æ¢ä¸ºå ä½å›¾åœ°å€ã€‚æ¥ç€ï¼Œä¸º `picture` æ ‡ç­¾æ·»åŠ æ‡’åŠ è½½ `lazy` æ ‡å¿—ï¼Œæ–¹ä¾¿è¿›è¡Œæ ·å¼ä¿®é¥°ã€‚ä¸ºäº†å…¼å®¹ SEOï¼Œå¢åŠ  `<noscript>` æ ‡ç­¾ï¼Œåœ¨å…¶ä¸­å­˜æ”¾çœŸå®çš„å›¾ç‰‡èµ„æºï¼š

{% codeblock lang:js mark:4,13-14 å…ƒç´ é¢„å¤„ç† %}
{
    const placeholder = "https://static.inkss.cn/img/default/loading.svg";

    img.setAttribute('data-src', src);
    img.setAttribute('src', placeholder);
    
    const noScript = document.createElement('noscript');
    const noScriptImg = document.createElement('img');
    noScriptImg.setAttribute('src', src);
    noScriptImg.setAttribute('alt', img.getAttribute('alt'));
    noScript.appendChild(noScriptImg);
    
    picture.classList.add("lazy")
    picture.appendChild(noScript);
    
    img.replaceWith(picture);
}
{% endcodeblock %}

æ¥ç€ç¼–å†™æ‡’åŠ è½½çš„å…·ä½“å®ç°ï¼Œåˆ©ç”¨ `IntersectionObserver` APIï¼Œä»…å½“å›¾ç‰‡æ˜¾ç¤ºåœ¨â€œè§†å£â€ï¼ˆviewportï¼‰ä¸­æ—¶ï¼Œæ‰åŠ è½½å›¾ç‰‡èµ„æºã€‚

{% link LazyLoader.js, https://gist.githubusercontent.com/inkss/6f76ec73bb34052dcd2976063b1884aa/raw/e9af74d607b396c79e9300c7cb7138bf253187bb/LazyLoader.js %}

```js ğŸŒ°ä½¿ç”¨ä¸¾ä¾‹
// å®ä¾‹åŒ–å¹¶ç›‘å¬
const lazyLoader = new LazyLoader("picture.lazy img");

// pjax ç­‰å›è°ƒä½¿ç”¨
lazyLoader.reinitObserver();
```

### 4.2 ä¸»é¢˜å…¼å®¹å¤„ç†

åœ¨ä¸»é¢˜ä¸­ï¼Œå¤§å¤šæ•°æ»šåŠ¨äº‹ä»¶ï¼ˆç›®å½•ã€é”šç‚¹ã€æœç´¢è¯å®šä½ï¼‰éƒ½æ˜¯é€šè¿‡`Window.scrollTo()`å®Œæˆçš„ã€‚å½“å±æ€§ behavior è¢«è®¾ç½®ä¸º *smooth*ï¼ˆå¹³æ»‘æ»šåŠ¨ï¼‰æ—¶ï¼Œé¡µé¢åœ¨æ»šåŠ¨åˆ°ç›®æ ‡å…ƒç´ çš„è¿‡ç¨‹ä¸­ä¼šåŠ è½½å›¾ç‰‡èµ„æºã€‚å› æ­¤ï¼Œéœ€è¦é¢å¤–åˆ¤æ–­ï¼šç”±ç¨‹åºå¼•å‘çš„æ»šåŠ¨äº‹ä»¶ä¸åº”è§¦å‘å›¾ç‰‡çš„æ‡’åŠ è½½ï¼Œæš‚åœå¯¹ç›®æ ‡å…ƒç´ æ˜¯å¦å¯è§çš„åˆ¤æ–­ã€‚

ä¸»é¢˜å¯¹æ»šåŠ¨äº‹ä»¶æä¾›äº†ä¸€ä¸ªå°è£…å‡½æ•°`volantis.scroll`ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªæ»šåŠ¨åˆ¤æ–­æ–¹æ³•`handleScrollEvents()`ï¼Œå®ƒçš„ä½œç”¨æ˜¯æ˜¯æŒç»­ç›‘æ§é¡µé¢çš„æ»šåŠ¨äº‹ä»¶å¹¶æ ¹æ®æ»šåŠ¨çŠ¶æ€è§¦å‘ç›¸åº”çš„é€»è¾‘ã€‚æˆ‘ä»¬æ–°å¢`handleScrollStop`æ–¹æ³•ï¼Œä¸»è¦æ£€æµ‹é¡µé¢æ»šåŠ¨ä½•æ—¶åœæ­¢ï¼Œå¹¶åœ¨æ»šåŠ¨åœæ­¢æ—¶è§¦å‘å›¾ç‰‡æ‡’åŠ è½½æ“ä½œï¼Œç¡®ä¿åªæœ‰åœ¨é¡µé¢æ»šåŠ¨åœæ­¢åæ‰è¿›è¡Œå›¾ç‰‡æ‡’åŠ è½½ã€‚æœ€ååœ¨`handleScrollEvents()`ä¸­è°ƒç”¨å³å¯ã€‚

{% codeblock lang:js mark:2,9,12,13 volantis.scroll.isScrolling ä¼šåœ¨å¼€å§‹æ»šåŠ¨æ—¶è®¾ç½®ä¸º true %}
volantis.scroll = {
    isScrolling: false,
    lastScrollTop: 0,
    scrollingTimeOut: null,

    handleScrollStop: () => {
        clearTimeout(volantis.scroll.scrollingTimeOut);
        volantis.scroll.scrollingTimeOut = setTimeout(() => {
            if (volantis.scroll.lastScrollTop === window.pageYOffset) {
                if (typeof lazyLoader.reinitObserver === 'function' 
                        && volantis.scroll.isScrolling) { 
                    volantis.scroll.isScrolling = false;
                    lazyLoader.reinitObserver();
                }
            }
        }, 100);
    }
}
{% endcodeblock %}

ç›¸åº”çš„ï¼Œä¿®æ”¹`LazyLoader`çš„å®ç°ï¼š

{% codeblock lang:js mark:2 åˆ¤æ–­ volantis.scroll.isScrolling %}
if (entry.isIntersecting
        && (!volantis?.scroll || !volantis?.scroll?.isScrolling)) {
    this.loadImage(entry.target);
    this.lazyPictureObserver.unobserve(entry.target);
    this.observedElements.delete(entry.target);
}
{% endcodeblock %}

### 4.3 ç¯ç®±å…¼å®¹å¤„ç†

ä¸»é¢˜æ‰€ä½¿ç”¨çš„ç¯ç®±æ’ä»¶ä¸º Fancyboxï¼Œæ— è®ºæ˜¯å›¾ç‰‡æ‡’åŠ è½½è¿˜æ˜¯ `<picture>` æ ‡ç­¾ï¼Œéƒ½å®¹æ˜“å­˜åœ¨ä¸€äº›é—®é¢˜ã€‚æ ¹æ® [fancyapps/ui/issue#379](https://github.com/fancyapps/ui/issues/379)ï¼Œ`v5.0.13` ç‰ˆæœ¬å¼€å§‹æ”¯æŒ `<picture>` æ ‡ç­¾ã€‚ç»“åˆæ–‡æ¡£ï¼Œåšå¦‚ä¸‹ä¿®æ”¹ï¼š

{% codeblock lang:js mark:5,7,11,17 åˆ¤æ–­ Fancybox é…ç½® %}
{
    Images: {
        content: (_ref, slide) => {
            const imgElement = slide.thumbEl;
            const pictureElement = imgElement.closest('picture');
            if (imgElement.hasAttribute('data-src')) {
                imgElement.setAttribute('src', imgElement.getAttribute('data-src'));
            }
            if (pictureElement) {
                pictureElement.classList.remove("lazy");
                let sources = pictureElement.getElementsByTagName('source');
                for (let source of sources) {
                    if (source.hasAttribute('data-srcset')) {
                        source.setAttribute('srcset', source.getAttribute('data-srcset'));
                    }
                }
                return pictureElement.outerHTML;
            } else {
                return imgElement.outerHTML;
            }
        }
    }
}
{% endcodeblock %}

### 4.4 è¿è¡Œæ—¶ä¿®æ”¹

ä»¥ä¸Šå¯¹å›¾ç‰‡çš„å‹ç¼©ã€è½¬æ¢å’ŒåŠ è½½æ–¹å¼çš„æ›¿æ¢ï¼Œéƒ½æ˜¯åœ¨ç”Ÿæˆé™æ€æ–‡ä»¶åï¼ˆ`hexo generate`ï¼‰è¿›è¡Œçš„ã€‚æŸç§æ„ä¹‰ä¸Šæ¥è¯´ï¼Œæœ¬åœ°æµ‹è¯•æ—¶æ— æ³•è§‚æµ‹åˆ°å›¾ç‰‡æ‡’åŠ è½½çš„å¤„ç†è¡Œä¸ºã€‚å› æ­¤ï¼Œå»ºè®®æ–°å»ºä¸€ä¸ª Hexo è¿‡æ»¤æ’ä»¶ï¼Œä»¥æ»¡è¶³åœ¨è¿è¡Œæ—¶ï¼ˆ`hexo server`ï¼‰è§‚å¯Ÿåˆ°å›¾ç‰‡æ‡’åŠ è½½çš„å¤„ç†è¡Œä¸ºã€‚

```js scripts/picture-wrapper.js
const cheerio = require('cheerio');
hexo.extend.filter.register('after_render:html', function (htmlContent) {
  if (this.env.cmd !== 'server') return htmlContent;

  const $ = cheerio.load(htmlContent);

  $('img').each(function () {
    const img = $(this);
    img.attr('data-src', img.attr('src'));
    img.attr('src', '/img/default/transparent-placeholder-1x1.svg');
    img.attr('loading', 'lazy');

    const picture = $('<picture class="lazy"></picture>');
    img.wrap(picture);
  });

  return $.html();
});
```

## äº”ã€é™„å½•å†…å®¹

*ä¸€äº›èƒ¡æ€ä¹±æƒ³çš„æ€è·¯ï¼Œä»…ä¾›å‚è€ƒã€‚*

é¦–å…ˆï¼Œæˆ‘ä»¬ä¾æ—§ç”ŸæˆåŒåçš„ *webp* å’Œ *avif* ç‰ˆæœ¬çš„å›¾ç‰‡ï¼Œç„¶åå°†æ‰€æœ‰å›¾ç‰‡å¼•ç”¨åœ°å€å…¨å±€æ›¿æ¢ä¸º *.avif* æ ¼å¼ã€‚æ¥ç€ï¼Œå¢åŠ å›¾ç‰‡åŠ è½½å¤±è´¥çš„åˆ¤æ–­é€»è¾‘ï¼Œæ£€æŸ¥æ–‡ä»¶æ ¼å¼å’Œèµ„æºæ¥æºï¼Œå¦‚æœåŠ è½½å¤±è´¥åˆ™å›é€€åˆ° *webp* æ ¼å¼é‡æ–°åŠ è½½ã€‚å€˜è‹¥å›é€€åä»ç„¶åŠ è½½å¤±è´¥ï¼Œé‚£ä¹ˆ{% bb è®©è€å¤è‘£ä»¬è‡ªä¸ªå„¿ç©å»å§~, å†è§å§æ‚¨å˜ï¼Œè¿˜ç”¨è¿™ä¹ˆå¤è€çš„æµè§ˆå™¨ %}ã€‚

{% codeblock lang:js mark:5,8 avif å›é€€ä¸º webp %}
const handleImageErrors = (event) => {
  const imgElement = event.target;

  if (imgElement.tagName === 'IMG') {
    const imageUrl = imgElement.dataset.src || imgElement.src;

    if (imageUrl.startsWith('XXXX') && imageUrl.endsWith('.avif')) {
      imgElement.src = imageUrl.replace(/\.avif$/, '.webp');
    }
  }
};

document.addEventListener('error', handleImageErrors);
{% endcodeblock %}
