---
title: 极空间防火墙配置避坑：IPv6 地址丢失（DHCPv6）教程
toc: true
indent: true
tag:
  - 极空间
  - IPV6
  - 防火墙
categories: 文档
description: 极空间系统新增防火墙实现设备级网络管控后，出现有状态 IPv6 地址丢失致远程访问失效问题。本文详细记录问题排查（定位 DHCPv6 响应被双重防火墙拦截）及解决方案（手动添加 UDP 546 端口放行规则）。
date: '2025-09-05 23:07'
updated: '2025-09-05 23:07'
headimg: ../../img/article/25-09@极空间防火墙与IPV6地址获取/Hexo博客封面.png
background: ../../img/background/wallhaven-pokg6p.avif
abbrlink: f2d9f349
---

极空间系统在新增防火墙功能后，实现了设备级的网络访问管控，为公网环境下的安全配置提供了更精细化的选项。然而，在实际配置过程中，由于底层防火墙规则设置过于简单粗暴，导致设备的 IPv6 地址异常丢失。

<!-- more -->

## 一、极空间防火墙

1. 规则类型与执行优先级

   - **通用规则**：对设备所有网卡生效的全局规则；


   - **网卡规则**：仅针对指定网卡生效的局部规则。


规则执行遵循固定顺序：**先匹配通用规则，再执行网卡规则**；两类规则均采用 “优先级递进” 机制 ——**规则排序越靠前，优先级越高**，若多个规则匹配同一网络请求，仅执行优先级最高的规则，避免规则冲突。

2. 默认行为配置原则

网卡规则支持 “拒绝访问” 与 “允许访问” 两类默认行为。按照常见防火墙配置习惯，将网卡规则的默认行为设为“拒绝访问”，并在通用规则中显式放行常用端口，采用白名单模式。

## 二、IPv6 地址丢失异常现象

防火墙配置完成后，极空间出现 IPv6 地址丢失问题，具体表现如下：

1. 网络环境背景

为提升内网设备的安全性（仅对部分设备分配 IPv6 地址）并实现统一管理，家庭网络采用 DHCPv6 有状态分配模式。此前，极空间设备在 IPv6 地址获取方面运行稳定，未出现异常断连。

2. 异常表现​

在配置防火墙后，极空间系统后台无法查询到 IPv6 地址，导致基于 IPv6 的远程访问功能完全失效。初步排查发现，该问题发生于 IPv6 前缀变更后，极空间未能同步更新公网 IPv6 地址，但重启设备后可重新获取最新地址。

## 三、IPv6 地址丢失问题的技术排查

排除路由器 DHCPv6 服务故障后，怀疑极空间本地问题，通过命令行工具定位问题根源：

1. DHCPv6 请求过程诊断

通过 SSH 登录极空间，执行 DHCPv6 请求诊断命令，获取地址获取过程日志：

```sh
sudo dhclient -6 -v bond0
```

2. 日志分析与问题定位

日志输出呈现两个关键特征：

- 持续输出 `XMT: Forming Solicit, ... ms elapsed.` 日志，表明极空间可正常发送 DHCPv6 Solicit 请求报文，排除请求发送异常；

- 无任何 RCV: 开头的日志，表明极空间未接收到路由器返回的 DHCPv6 响应报文，确认响应报文被拦截。

进一步查看防火墙规则，发现网卡规则设置 “默认拒绝” 后，系统会在防火墙链末尾添加如下规则：

```sh
DROP all bond0 * ::/0 ::/0
```

具体来讲，极空间 NAS 使用了**两套防火墙系统**同时工作，形成了“双重过滤”：

1. **`INPUT_ZFIREWALL` (极空间自定义防火墙链)**：
   - 默认策略的最后一条规则为：
   
     `DROP all bond0 * ::/0 ::/0`
   
   - 这条规则的作用是**丢弃所有从 `bond0` 接口进入 (`INPUT`) 的 IPv6 数据包**。
   
2. **`ufw6-*` (Ubuntu 防火墙 UFW)**：
   
   - 该规则链包含允许 DHCPv6 的规则：
     
     `4 620 ACCEPT udp * * fe80::/10 fe80::/10 udp spt:547 dpt:546`
   - 这条规则允许 DHCPv6 通信，但**它只适用于链路本地地址 (`fe80::/10`)**。对于从路由器全球单播地址发来的响应，不匹配此规则。

而极空间的防火墙链会优先执行，路由器的 DHCPv6 响应包在到达系统网络栈之前就被丢弃了。

## 四、DHCPv6 响应报文放行规则

一般来讲，正常的防火墙规则应该包含**“有状态检测”(Stateful Inspection)**机制，允许已建立连接及相关连接 (ESTABLISHED, RELATED) 的流量进入。然而极空间的防火墙正缺少这类机制，为解决该问题，需手动添加一条静态放行规则：

- 协议：“UDP”；

- 端口类型：“目标端口”；

- 端口：“546”；
- 发起端 IP：“所有” or ”`:: ~ ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff`”。

