---
title: 极空间 SSH 开启后必做 4 件事
toc: true
indent: true
tag:
  - Linux
  - 极空间
categories: 文档
date: '2025-09-11 21:40'
updated: '2025-09-16 15:05'
hidden: false
description: >-
  极空间开启 SSH 后能做什么？本文汇总 4 大高频应用场景：1Panel 面板安装（简化系统管理）、桌面端样式修饰、存储池镜像同步、OneDrive
  云端备份，全流程附命令代码指南。
headimg: ../../img/article/25-09@极空间SSH开启后必做4件事/Hexo博客封面.png
abbrlink: 3af25609
---

极空间终于开放了 SSH 权限，真是来之不易。此前的限制简直像是在防“家贼”，让人颇感无奈。现在可以在「设置 → 系统设置 → 远程协助 → SSH」中开启 SSH 访问权限，同时默认的 Docker 应用也支持设置为 Privileged Mode，算是一次不小的进步。不过话说回来，它仍然对端口（仅允许 10000 以上）和账户做了不少限制。既然都已经开放权限了，这种“半放半收”的做法就显得有些矫情了。

## 一、服务器面板

### 面板选取

极空间的 ZOS 系统是基于 Linux 深度定制的操作系统，本质上可以视作一台服务器。为了更高效地管理该系统，使用服务器面板便成为最佳选择——毕竟在有条件使用 GUI 的前提下仍坚持使用命令行过于愚蠢。

至于为何选择 1Panel 而非宝塔，主要基于以下两点考虑：

- **隐私安全**：宝塔面板在安装过程中强制要求绑定用户手机号，并上传服务器配置信息，此举有隐私风险之嫌。

- **系统侵入性**：宝塔面板采用原生方式安装，对系统结构改动较大。而极空间作为一款 NAS 设备，稳定性应为首要考量。相比之下，1Panel 基于 Docker 部署，对底层系统的影响更小，更符合轻量化与可控性的需求。

### 安装 1Panel

参考飞致云文档，安装脚本如下：

```shell
bash -c "$(curl -sSL https://resource.fit2cloud.com/1panel/package/v2/quick_start.sh)"
```

**注意事项**：在安装 1Panel 过程中，其安装脚本会提示覆盖 Docker 的 `daemon.json` 配置文件，并自动将原始内容备份为同目录下的 `daemon.json.1panel_bak` 文件。通过该备份文件可知，极空间系统将 Docker 的数据目录设定为 `/data_n002/data/udata/real/zdocker`。由于 1Panel 会覆盖该配置并重启 Docker，极空间自带的容器管理应用将因此无法识别原有容器部署，导致管理功能失效。

**解决方案**：将 `daemon.json.1panel_bak` 中的原始配置内容恢复写入 `daemon.json`，随后重启 Docker 引擎，即可恢复极空间的容器管理能力。

### 闪存容量提醒

极空间设备的闪存容量较为有限。以我使用的 Z4S 为例，其总闪存空间为 14.6G，其中仅有 6.5G 分配给根目录。在安装 1Panel 面板时，若采用默认安装路径，可能导致根分区空间被迅速占满，影响系统稳定性。因此，**务必在安装时修改默认安装位置**，以避免根目录空间耗尽。

```sh
➜  ~ lsblk -o NAME,SIZE,TYPE,MOUNTPOINT | grep mmcblk
mmcblk0          14.6G disk  
├─mmcblk0p1       285M part  /boot/efi
├─mmcblk0p2       6.5G part  /
└─mmcblk0p3       7.7G part  /zspace
```

## 二、桌面端样式修改

极空间桌面端目录位于：

```bash
/zspace/applications/services/pcweb/home/
```

### ~~登录页 UA 校验~~

~~极空间的登录页面存在一个令人反感的跳转问题：当使用移动端 User-Agent 访问时，页面会自动跳转至极空间的 App 下载页面。为解决此问题，可以直接移除页面中的跳转逻辑。具体操作如下：进入桌面端应用目录，定位并编辑 *index.html* 文件，删除或屏蔽与移动端跳转相关的脚本代码，即可恢复正常访问。~~

{% folding cyan, <s>删除这个判断函数（点击展开）</s> %}

```html
<script>var j = function(url) {
      window.stop && window.stop()
      document.execCommand && document.execCommand("Stop", false)
      window.location = url
    }
    function getCookie(key) {
      var cookies = document.cookie.split("; ");
      for (var i = 0; i < cookies.length; i++) {
        var cookie = cookies[i]
        if (cookie.indexOf(key + "=") === 0) {
          return decodeURIComponent(cookie.substring((key + "=").length, cookie.length))
        }
      }
      return ""
    }
    if (getCookie('token') != '' && getCookie('nas_id') == '') {
      j('/home/error/504.html?clear')
    }
    var ua = navigator.userAgent.toLowerCase()
    var isMobile = !!ua.match(/iOS|iPhone|Android|windows Phone|BB\d+/i)
    var isIPad = !!ua.match(/ipad/i)
    var href = window.location.href
    if(!Object.defineProperty||!Array.prototype.forEach) j("/home/error/browser.html")
    else if (/^http:\/\/(\w+\.)?zconnect.cn((?!login\/jump).)*$/.test(href)) j('https' + href.substr(4))</script>
```

{% endfolding %}

{% note info yellow::更正：极空间近期更新已移除该跳转，此步骤可省略。 %}

### 极空间样式修饰

类似于前文所述的登录页 UA 校验修改，我们也可以手动插入 CSS 链接，注入个性化样式修订。

{% tabs scss %}

<!-- tab 简介 -->

修改列表：登录页样式跳转、全部应用页样式调整、最大化窗口时覆盖 Dock 和导航栏等。将样式代码写入进 `custom.min.css` 并保存到 `index.html` 同目录中，并添加引用：

```html
<link href='/home/custom.min.css?v=1' rel='stylesheet'>
```

<!-- endtab -->

<!-- tab 样式文件 -->

```css custome.css
@charset "UTF-8";.copyright, .loginFooter > .tc, .login > .titleText div:not(:first-child) {display: none;}body.normal #app .contain:has(.login) {background-image: url("https://inkss.cn/img/wallhaven-w58mv7.png");position: relative;display: flex;justify-content: center;align-items: center;}body.normal #app .contain:has(.login) .login {background: #d5d7ec00;box-shadow: 0 25px 45px #0000001a;transition: 0.5s;border-radius: 2px;}body.normal #app .contain:has(.login) .login:hover, body.normal #app .contain:has(.login) .login:has(input:focus) {border-radius: 30px;backdrop-filter: blur(10px);}body.normal #app .contain:has(.login) .login .titleText::before {content: "";position: relative;display: block;bottom: -40px;width: 0;height: 3px;background: white;transition: 0.5s;border-radius: 2px;}body.normal #app .contain:has(.login) .login .titleText:hover::before {width: 60px;}body.normal #app .contain:has(.login) .login .el-button {width: inherit;background-color: #f4d2d280;transition: 0.5s;}body.normal #app .contain:has(.login) .login .el-button:hover {transform: scale(0.98);}body.normal #app .contain:has(.login) .login .loginFooter .el-checkbox {transition: 0.5s;}body.normal #app .contain:has(.login) .login .loginFooter .el-checkbox:hover {transform: scale(1.1);}body.normal #app .contain:has(.login) .login .loginFooter .el-checkbox .el-checkbox__inner {border: 1px solid #feffff59;background-color: #feffff59 !important;}body.normal #app .contain:has(.login) .login .el-input::after {content: "";width: 0;transition: 0.5s;}body.normal #app .contain:has(.login) .login .el-input:hover::after, body.normal #app .contain:has(.login) .login .el-input:has(input:focus)::after {width: 450px;}body.normal #app .contain:has(.login) .login .el-input input::placeholder {color: #fbf1f1;}body.normal #app .home .windows .devName.bold {width: 40px;overflow: hidden;}body.normal #app .home .windows .devName.bold img {display: none;}body.normal #app .home .desktop .widget .actIcon {opacity: 0;transition: opacity 0.5s;}body.normal #app .home .desktop .widget:hover .actIcon {opacity: 1;}body.normal #app:has(.maximum.active):not(:has(.noframeViewerTheme.active)) .winOperateArea, body.normal #app:has(.maximum.active):not(:has(.noframeViewerTheme.active)) .rightArea > *:not(.insteadOfWinOperateIcon) {display: none;}body.normal #app:has(.maximum.active):not(:has(.noframeViewerTheme.active)) .main {top: 0;z-index: 10;}body.normal #app:has(.maximum.active):not(:has(.noframeViewerTheme.active)) .main .siderBar {display: none;}body.normal .setup-popper .userInfo .nickname {display: flex;flex-direction: column;}body.normal .setup-popper .userInfo .nickname::after {content: '言语道断，非物所拘。';font-weight: 500;font-size: 13px;line-height: 15px;color: #666;white-space: nowrap;margin-top: 4px;}body.normal .setup-popper .userInfo .username, body.normal .setup-popper .userInfo .userInfoBottomItem:has(.nasName) {display: none;}
```

{% folding cyan,  原始未压缩版本 %}

```scss custom.scss
// SCSS TO CSS: https://www.dute.org/sass-to-css
@charset "UTF-8";

// 隐藏元素
.copyright,
.loginFooter > .tc,
.login > .titleText div:not(:first-child) {
  display: none;
}

// 颜色变量
$input-placeholder-color: #fbf1f1;
$box-shadow-color: #0000001a;
$border-color: #feffff59;
$login-bg-color: #d5d7ec00;
$btn-bg-color: #f4d2d280;
$checkbox-bg-color: #feffff59;

// 通用过渡效果
$transition: 0.5s;

// 正常模式样式
body.normal {
  #app {
    // 登录组件样式
    .contain:has(.login) {
      background-image: url('https://inkss.cn/img/wallhaven-w58mv7.png');
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;

      .login {
        background: $login-bg-color;
        box-shadow: 0 25px 45px $box-shadow-color;
        transition: $transition;
        border-radius: 2px;

        &:hover,
        &:has(input:focus) {
          border-radius: 30px;
          backdrop-filter: blur(10px);
        }

        .titleText {
          &::before {
            content: "";
            position: relative;
            display: block;
            bottom: -40px;
            width: 0;
            height: 3px;
            background: white;
            transition: $transition;
            border-radius: 2px;
          }

          &:hover::before {
            width: 60px;
          }
        }

        .el-button {
          width: inherit;
          background-color: $btn-bg-color;
          transition: $transition;

          &:hover {
            transform: scale(0.98);
          }
        }

        .loginFooter .el-checkbox {
          transition: $transition;

          &:hover {
            transform: scale(1.1);
          }

          .el-checkbox__inner {
            border: 1px solid $border-color;
            background-color: $checkbox-bg-color !important;
          }
        }

        .el-input {
          &::after {
            content: "";
            width: 0;
            transition: $transition;
          }

          &:hover::after,
          &:has(input:focus)::after {
            width: 450px;
          }

          input::placeholder {
            color: $input-placeholder-color;
          }
        }
      }
    }

    // 主页组件样式
    .home {
      .windows .devName.bold {
        width: 40px;
        overflow: hidden;

        img {
          display: none;
        }
      }

      .desktop .widget {
        .actIcon {
          opacity: 0;
          transition: opacity $transition;
        }

        &:hover .actIcon {
          opacity: 1;
        }
      }
    }

    // 最大化窗口模式样式
    &:has(.maximum.active):not(:has(.noframeViewerTheme.active)) {
      .winOperateArea,
      .rightArea > *:not(.insteadOfWinOperateIcon) {
        display: none;
      }

      .main {
        top: 0;
        z-index: 10;

        .siderBar {
          display: none;
        }
      }
    }
  }

  // 设置弹出框样式
  .setup-popper .userInfo {
    .nickname {
      display: flex;
      flex-direction: column;

      &::after {
        content: '言语道断，非物所拘。';
        font-weight: 500;
        font-size: 13px;
        line-height: 15px;
        color: #666;
        white-space: nowrap;
        margin-top: 4px;
      }
    }

    .username,
    .userInfoBottomItem:has(.nasName) {
      display: none;
    }
  }
}
```

{% endfolding %}

<!-- endtab -->

<!-- tab 效果展示 -->

{% p center logo, 效果展示极对比：左图为默认效果，右图为覆盖样式后效果。 %}

{% gallery stretch::2::IMG %}

![登录页：原](../../img/article/25-09@极空间SSH开启后必做4件事/0916142826.png)

![登录页：改](../../img/article/25-09@极空间SSH开启后必做4件事/image-20250911115014562.png)

![最大化窗口：原](../../img/article/25-09@极空间SSH开启后必做4件事/0916142716.png)

![最大化窗口：改](../../img/article/25-09@极空间SSH开启后必做4件事/image-20250911121916689.png)

![桌面：原](../../img/article/25-09@极空间SSH开启后必做4件事/0916142802.png)

![桌面：改](../../img/article/25-09@极空间SSH开启后必做4件事/image-20250911121936271.png)

{% endgallery %}

![菜单页](../../img/article/25-09@极空间SSH开启后必做4件事/image-20250916144955763.png)

<!-- endtab -->

{% endtabs %}

### 自动化部署脚本

极空间在每次系统更新时会重置该文件，可通过编写脚本并配置至 1Panel 的定时任务中自动恢复修改。

{% p left logo, 脚本实现功能如下： %}

1. 替换标题并引用 CSS：检测 index.html 原标题，替换为新标题且添加自定义 CSS 引用；

2. 复制覆盖资源：将指定的自定义 CSS 和网站图标，强制复制到目标目录覆盖旧文件；

3. 前置环境检查：验证目标文件 / 目录可写性、依赖工具是否存在等。

```sh 文件目录结构（部分）
/zspace/applications/services/pcweb/
├── home
│   └── index.html
└── template
    ├── custom.min.css
    ├── custom.scss
    └── favicon.ico
```

{% folding cyan, check_index.sh %}

```sh check_index.sh
#!/bin/bash

# 配置项
CONFIG=(
    "file_path=/zspace/applications/services/pcweb/home/index.html"
    "title_search=<title>极空间 - 私有云</title>"
    "title_replace=<title>柚子屋</title><link href='/home/custom.min.css?v=1' rel='stylesheet'>"
    "css_source=/zspace/applications/services/pcweb/template.min.css"
    "favicon_source=/zspace/applications/services/pcweb/templaten.ico"
    "target_dir=/zspace/applications/services/pcweb/home/"
)
backup_path="${CONFIG[0]#*=}.bak"

# 日志函数
log() {
    local level="$1"
    shift
    local message="$(date "+[%Y-%m-%d %H:%M:%S]") [$level] $*"
    echo "$message" >&2
}

# 检查文件和目录
check_prerequisites() {
    local file_path="${CONFIG[0]#*=}"
    local target_dir="${CONFIG[5]#*=}"
    if [ ! -f "$file_path" ] || [ ! -w "$file_path" ]; then
        log "ERROR" "文件 $file_path 不存在或不可写。"
        exit 1
    fi
    if [ ! -d "$target_dir" ] || [ ! -w "$target_dir" ]; then
        log "ERROR" "目标目录 $target_dir 不存在或不可写。"
        exit 1
    fi
    if ! command -v perl >/dev/null; then
        log "ERROR" "Perl 未安装，请安装 perl。"
        exit 1
    fi
    log "INFO" "检查通过：文件和目录存在且可写，Perl 可用。"
}

# 备份文件
backup_file() {
    local file_path="${CONFIG[0]#*=}"
    if [ -f "$backup_path" ]; then
        log "INFO" "备份文件 $backup_path 已存在，跳过备份。"
        return 0
    fi
    if cp "$file_path" "$backup_path" && cmp -s "$file_path" "$backup_path"; then
        log "INFO" "备份成功：文件已备份到 $backup_path。"
    else
        log "ERROR" "备份文件 $file_path 失败。"
        exit 1
    fi
}

# 替换内容
replace_content() {
    local file_path="${CONFIG[0]#*=}"
    local title_search="${CONFIG[1]#*=}"
    local title_replace="${CONFIG[2]#*=}"

    # 检测标题是否需要替换
    grep -q "$title_search" "$file_path" && title_needs_replace=1 || title_needs_replace=0

    if [ "$title_needs_replace" -eq 0 ]; then
        log "INFO" "文件已符合目标状态，无需修改。"
        return 0
    fi

    # 备份并替换
    backup_file
    cp "$file_path" "$file_path.tmp" || { log "ERROR" "创建临时文件失败。"; exit 1; }
    if [ "$title_needs_replace" -eq 1 ]; then
        if sed "s|$title_search|$title_replace|" "$file_path.tmp" > "$file_path.tmp2" && mv "$file_path.tmp2" "$file_path.tmp"; then
            log "INFO" "替换成功：已更新标题。"
        else
            mv "$file_path.tmp" "$file_path"
            log "ERROR" "标题替换失败，已回滚。"
            exit 1
        fi
    fi

    # 更新文件
    mv "$file_path.tmp" "$file_path" || { log "ERROR" "更新文件失败。"; exit 1; }
}

# 复制自定义文件
copy_custom_files() {
    local target_dir="${CONFIG[5]#*=}"
    for src in "${CONFIG[3]#*=}" "${CONFIG[4]#*=}"; do
        if [ ! -f "$src" ]; then
            log "ERROR" "源文件 $src 不存在。"
            exit 1
        fi
        if ! cp -f "$src" "$target_dir"; then
            log "ERROR" "无法复制 $src 到 $target_dir。"
            exit 1
        fi
    done
    log "INFO" "复制成功：已更新 custom.min.css 和 favicon.ico。"
}

# 主逻辑
main() {
    log "INFO" "开始执行脚本..."
    check_prerequisites
    replace_content
    copy_custom_files
    log "INFO" "脚本执行完成。"
}

# 执行主逻辑
main
```

{% endfolding %}

![配置检验](../../img/article/25-09@极空间SSH开启后必做4件事/image-20250916145914072.png)

## 三、存储池之间镜像同步

目前，极空间备份中心在存储池间的备份机制采用增量同步，这会造成备份目录与源目录内容不一致，缺失镜像同步功能。为解决此问题，可编写 Rsync 脚本，并通过 1Panel 的定时任务功能定期执行。

```txt 极空间存储目录结构
/tmp/zfsv3/存储硬盘类型/用户手机号/data/
```

{% folding cyan,  rsync 脚本 %}

```sh 根据个人情况自行替换脚本内容
#!/bin/bash

# 定义需要同步的目录对
declare -a directories=(
    "/tmp/zfsv3/nvme12/XXXX/data/相册存储:/tmp/zfsv3/sata1/XXXX/data/备份中心/相册存储"
    "/tmp/zfsv3/nvme12/XXXX/data/文档同步/手机备份:/tmp/zfsv3/sata1/XXXX/data/备份中心/手机备份"
    # 原始目录:备份目录
    # more...
)

# 获取当前时间并格式化
log() {
    echo "$(date "+[%Y-%m-%d %H:%M:%S]") $1"
}

# 记录开始时间
log "同步开始"

# 同步函数
sync_directories() {
    local source_dir="$1"
    local target_dir="$2"

    # 检查源目录是否存在
    if [ ! -d "$source_dir" ]; then
        log "源目录 $source_dir 不存在。"
        exit 1
    fi

    # 检查目标目录是否存在，如果不存在则创建
    if [ ! -d "$target_dir" ]; then
        log "警告：目标目录 $target_dir 不存在，正在创建..."
        mkdir -p "$target_dir"
        if [ $? -ne 0 ]; then
            log "创建目标目录 $target_dir 失败。"
            exit 1
        fi
    fi

    log "同步 $source 到 $target..."
    # 使用 rsync 进行同步，并记录详细日志
    rsync -av --delete "$source_dir/" "$target_dir/" | while read line; do
        log "$line"
    done

    # 检查 rsync 命令是否成功
    if [ $? -eq 0 ]; then
        log "同步成功！已将 $source_dir 下的文件同步到 $target_dir。"
    else
        log "同步失败！请检查问题并重新尝试。"
        exit 1
    fi
}

# 遍历数组并调用同步函数
for pair in "${directories[@]}"; do
    IFS=":" read -r source target <<< "$pair"
    sync_directories "$source" "$target"
done

log "同步完成"

```

{% endfolding %}

![镜像同步](../../img/article/25-09@极空间SSH开启后必做4件事/image-20250916145609975.png)

## 四、OneDrive 云端备份

极空间备份中心虽支持云端备份，但不知从何时起，OneDrive 备份功能在上传文件过程中会修改文件时间属性，导致图片类文件丢失原始元数据而无法正常使用。为规避该问题，可使用 rclone 工具自行实现 OneDrive 备份。

- 参考[官方教程](https://rclone.org/install/#quickstart)进行 rclone 的安装：

```sh
sudo -v ; curl https://rclone.org/install.sh | sudo bash
```

- 参考该教程进行 Onedrive 的连接配置：[Microsoft OneDrive](https://rclone.org/onedrive/)

  - client_id 和 client_secret 的获取参考这篇文章：[vps使用rclone挂载OneDrive详细记录](https://pickstar.today/2023/01/vps使用rclone挂载onedrive详细记录/)

- rclone 命令参考：

  ```sh 同步文件
  rclone sync /local/file <远端名称>:/remote/file
  ```

  ```sh 配置密码
  rclone config password
  ```

最后我们编写个脚本，方便在计划任务中调用：

{% folding cyan,  rclone 脚本 %}

```sh 根据个人情况自行替换脚本内容
#!/bin/bash

# rclone 密码
export RCLONE_CONFIG_PASS="XXXXXX"

# 定义本地和远程目录数组
declare -A directories=(
    ["/tmp/zfsv3/sata1/XXXX/data/备份中心/相册存储"]="<远端名称>:/备份/异地云备/相册存储"
    ["/tmp/zfsv3/sata1/XXXX/data/备份中心/手机备份"]="<远端名称>:/备份/异地云备/手机备份"
    # 添加更多的目录对
)

# 获取当前时间并格式化
current_time() {
    date "+[%Y-%m-%d %H:%M:%S]"
}

# 记录开始时间
echo "$(current_time) 备份开始"

# 循环同步每个目录对
for local_dir in "${!directories[@]}"; do
    remote_dir=${directories[$local_dir]}
    echo "$(current_time) 同步 $local_dir 到 $remote_dir..."
    
    # 同步操作，并捕获错误
    if rclone sync "$local_dir" "$remote_dir" --progress; then
        echo "$(current_time) 完成 $local_dir 同步"
    else
        echo "$(current_time) 失败 $local_dir 同步"
        exit 1
    fi
done

# 输出备份完成消息并记录结束时间
echo "$(current_time) 所有备份已完成！"
echo "$(current_time) 备份结束"

# 取消设置环境变量
unset RCLONE_CONFIG_PASS
```

{% endfolding %}

![云备](../../img/article/25-09@极空间SSH开启后必做4件事/image-20250916145222981.png)

## 五、极影视合集时间

在极影视中按时间排序时，合集会被排到最后，因为数据库中的 `release_year` 和 `release_date` 为空。要避免这种情况，可以在数据库中填补这两个字段的值。

![zvideo](../../img/article/25-09@极空间SSH开启后必做4件事/Snipaste_2024-12-06_22-33-00.png)

极影视的数据库文件位于 `/zspace/zsrp/sqlite/zvideo/zvideo.db`，修改前请记得备份该文件。

{% folding cyan, update_zvideo.sql %}

```sql
-- 开始事务以确保数据更新的原子性
BEGIN;

-- 确保临时表不存在
DROP TABLE IF EXISTS temp_zvideo;

-- 步骤1：创建临时表
CREATE TEMPORARY TABLE temp_zvideo (
    id INTEGER,
    title VARCHAR(250),
    auto_series_id VARCHAR(64),
    user_name VARCHAR(50),
    release_year VARCHAR(16),
    release_date INTEGER,
    release TEXT
);

-- 步骤1.1：插入数据到临时表
INSERT INTO temp_zvideo
SELECT DISTINCT zc.id, zc.title, zc.auto_series_id, zc.user_name, 
       COALESCE(zc2.release_year, zc.release_year) AS release_year, 
       COALESCE(zc2.release_date, zc.release_date) AS release_date,
       COALESCE(zc2.release, zc.release) AS release
FROM zvideo_collection zc
LEFT JOIN (
    SELECT auto_series_id, user_name, release_year, release_date, release
    FROM zvideo_collection zc2
    WHERE extend_type != 7
    AND release_date = (
        SELECT MAX(release_date)
        FROM zvideo_collection zc3
        WHERE zc3.auto_series_id = zc2.auto_series_id
        AND zc3.user_name = zc2.user_name
        AND zc3.extend_type != 7
        AND zc3.release_date IS NOT NULL
    )
) zc2 ON zc.auto_series_id = zc2.auto_series_id AND zc.user_name = zc2.user_name
WHERE zc.extend_type = 7;

-- 步骤2：更新原表
UPDATE zvideo_collection
SET 
    release_year = COALESCE((
        SELECT release_year
        FROM temp_zvideo
        WHERE temp_zvideo.id = zvideo_collection.id
    ), release_year),
    release_date = COALESCE((
        SELECT release_date
        FROM temp_zvideo
        WHERE temp_zvideo.id = zvideo_collection.id
    ), release_date),
    release = COALESCE((
        SELECT release
        FROM temp_zvideo
        WHERE temp_zvideo.id = zvideo_collection.id
    ), release)
WHERE id IN (SELECT id FROM temp_zvideo);

-- 步骤3：删除临时表
DROP TABLE temp_zvideo;

-- 提交事务
COMMIT;

-- 检查更新行数
SELECT changes() AS rows_updated;
```

{% endfolding %}

{% folding cyan, update_zvideo.sh %}

```bash
#!/bin/bash

# 定义常量
DB_PATH="/zspace/zsrp/sqlite/zvideo/zvideo.db"  # SQLite 数据库文件路径
SQL_FILE="/opt/credentials/sql/update_zvideo.sql"  # SQL 脚本文件路径
MAX_RETRIES=10  # 最大重试次数
RETRY_INTERVAL=5  # 重试间隔时间（秒）

# 日志函数，记录带时间戳的消息
log() {
    echo "$(date "+[%Y-%m-%d %H:%M:%S]") $1"
}

# 检查 sqlite3 命令是否可用
if ! command -v sqlite3 &> /dev/null; then
    log "错误：sqlite3 未安装，请先安装 sqlite3。"
    exit 1
fi

# 检查文件是否存在，提升脚本鲁棒性
if [ ! -f "$DB_PATH" ]; then
    log "错误：数据库文件 $DB_PATH 不存在。"
    exit 1
fi
if [ ! -f "$SQL_FILE" ]; then
    log "错误：SQL 文件 $SQL_FILE 不存在。"
    exit 1
fi

log "开始更新数据库..."

# 初始化重试计数器
retry_count=0

# 使用循环处理数据库锁定情况
while [ $retry_count -lt $MAX_RETRIES ]; do
    # 执行 SQL 脚本，捕获输出和状态码
    output=$(sqlite3 "$DB_PATH" < "$SQL_FILE" 2>&1)
    status=$?

    # 检查执行结果
    if [ $status -eq 0 ]; then
        log "数据库更新成功完成。更新行数：$output"
        break  # 成功后退出循环
    else
        # 检查是否因数据库锁定失败
        if echo "$output" | grep -q "database is locked"; then
            retry_count=$((retry_count + 1))
            log "数据库被锁定，等待 $RETRY_INTERVAL 秒后重试... (尝试 $retry_count/$MAX_RETRIES)"
            sleep $RETRY_INTERVAL
        else
            log "数据库更新失败，错误信息如下："
            log "$output"  # 直接打印错误信息
            exit 1  # 非锁定错误，直接退出
        fi
    fi
done

# 检查是否达到最大重试次数
if [ $retry_count -eq $MAX_RETRIES ]; then
    log "错误：达到最大重试次数 $MAX_RETRIES，数据库仍被锁定，更新失败。"
    exit 1
fi

log "数据库更新过程结束。"
```

{% endfolding %}

![合集更新](../../img/article/25-09@极空间SSH开启后必做4件事/image-20250916145739209.png)
