---
title: Volantis：自定义右键菜单实现
toc: true
indent: true
tag:
  - Clipboard
  - Volantis
categories: 前端
description: 使用原生 JS 语法实现网站的自定义右键菜单。
date: '2022-04-18 20:00'
updated: '2022-04-18 22:03'
abbrlink: 3717f151
background: ../../img/article/自动化博客部署/wallhaven-48o37j.png
---

{% image ../../img/article/22-04@原生JS的右键实现/image-20220418232017851.png::height=267px %}

## 一、前缘

Volantis 的右键大体来说是我维护的，它的由来其实很有趣：当时是做了全局鼠标形状替换，但是在右键菜单展现时图标的修改被打回了原形，所以就萌生了替换掉右键菜单的想法。第一版的右键是仿照主题的菜单实现的，样式直接引用自菜单，功能上只是单纯的链接跳转。

后来 xaoxuu 觉得这个不错，就添加了顶部导航栏、音乐控制模块等，将自定义右键抽成了独立的功能，如此算是有了一个良好的开端；接着就是一些功能上的增减，主要围绕剪切板和内置事件展开；再后来 Volantis 开始去 JQ 化，右键也就跟着摘掉依赖，如此迭代后，才形成了目前主题内置的右键状态。

此时的右键菜单，所有的功能类按钮的事件实现全部内置，用户在配置方面只能做到新建一些静态链接、调调顺序罢了，而在代码实现上，逻辑实现提示挺弯弯绕的，灵活性极差。功能少自然配置上也就简单一些，这算是另类的优点吧。基本的，目前无法手动添加事件执行类的菜单项目，同时内部的菜单项是写死在页面中的，如果想要对这部分进行修改只能去改源码。另外也无法自行响应右键在不同状态下打开时的行为，所以主要的改进有两点：*菜单动态生成、支持自定义脚本。*

## 二、设计

后来也看到了其他博客的右键实现，比如糖果屋、Heo 博客的，不过理想中最完善的自定义右键是 Code-Server，奈何这类大项目真读起来还是太费时间的就没有太过研究，不过重写右键的想法确实被勾起了。原先在右键的功能上的实现有过一些积累，见文章 “[前端页面的自定义右键与剪切板操作实现](/blog/63296e49/)”，一并可以拿来参考，接着就是重新设计右键菜单的实现了。

### 配置文件

重构是从配置文件开始的，由于要实现动态菜单，我需要一个统一的菜单对象：


```yml
- {id: '', name: '', icon: '', link: '', event: '', group: ''}
```

`id`, `name`, `icon` 作为基本的属性就不多提了，用来匹配菜单名称和图标；对于链接性质的菜单项，直接将地址填写进 `link` 中，使用时渲染成 `a` 链接即可；而对于事件形式的菜单项，写入到 `event` 里，这里就需要区分内置事件和用户自行输入的事件，所以维护一个内置事件列表，如果输入内容与内置事件匹配，调用右键菜单的内置实现，其余的当作自定义脚本执行；而 `group` 主要用于区分响应行为上，比如只在图片上右键时才显示菜单项，同样维护一个内置组。

一个组中可以拥有单个或多个菜单项，内置组根据右键时的状态确定组内菜单是否显示。在不考虑二级菜单的情况下，为了减少整个菜单的数量（长度），含有 `event` 的组显示时隐藏掉含有 `link` 项的菜单：基本链接型的菜单都是用户添加，功能型的菜单动态出现。

### 启用及排序

为了进一步区分，菜单项分为 `plugins` 和 `menus` 两大类，在使用上通过 `plugins/menus.[组名]` 的方式控制菜单的启用及排序，例如：

```yml
order:
  - plugins.elementCheck
  - hr
  - menus.links
  - menus.links2
plugins:
  elementCheck
    - {}
    - hr
    - {}
menus:
  links:
    - {}
  links2: {}
```

这里利用 `order` 控制具体加载的组，同时对于一些特殊的功能，如分割线（*hr*）和音乐控制器（*music*），也是在这个属性中配置的，属性项目的前后顺序代表了菜单加载的前后顺序。

## 三、实现

有了数据模型，接下来就是对它的功能实现了。

### 页面渲染

### 功能实现



**未完待续**